# Express CSRF

This project covers the concept of CSRF (Cross-Site Request Forgery) and CSRF Token implementation in Express.js(a Node.js framework).

## Understanding CSRF

Cross-Site Request Forgery (CSRF) is an attack that forces authenticated users to submit a request to a Web application against which they are currently authenticated. CSRF attacks exploit the trust a Web application has in an authenticated user. (Conversely, cross-site scripting (XSS) attacks exploit the trust a user has in a particular Web application). A CSRF attack exploits a vulnerability in a Web application if it cannot differentiate between a request generated by an individual user and a request generated by a user without their consent.

## What is CSRF Token?

A CSRF Token is a piece of data that is random, unique, and attached to a form. Often, this data is included in a hidden input tag with the data stored in its value attribute.

Here’s a simple example of what a CSRF Token looks like:

```
<form method='POST' action='/'>
 <input type="hidden" name="csrf_token" value="this-can-be-any-random-string" />

 <label for="name">Name</label>
 <input type="text" name="name" />

 <button type="submit"/>
</form>
```

The first input with the name `csrf_token` is the actual CSRF token.
To function properly, the CSRF token must be generated by the server and then rendered on the page where the form is held. Then, all requests from that page will have the input with the `csrf_token` name included in the request, and all requests which are made cross-site will not have it.

The reason why cross-site requests do not contain the CSRF token is that the server must render the actual page where the form is held to attach the CSRF token to the form which makes the desired request.

When a request is made to the relevant route, the CSRF token in the form must be matched against the CSRF token stored by the server. If the CSRF token is not present or does not match the CSRF token persisted on the server for that user’s session, the request cannot be completed.

## Application setup

### 1. Prerequisites

Node.js v16, npm v8

**NOTE**: although code can be done in another version, we are using this version because it is the latest at the time of coding with long-term support.

### 2. Base setup and required packages installation

```
$ mkdir express-csrf
$ npm init -y
$ npm install cookie-parser cookie-session express http-errors morgaon pug
$ npm install -D nodemon prettier
```

The `cookie-session` package will be used to create a session where the CSRF token can be stored, accessed, and destroyed.
To use `cookie-session`, require it at the top of ./server.js and use it right after `app.use(cookieParser())`.

### 3. Creating required code

#### 3.1 create `server.js` file in ROOT

- [server.js](/server.js)

#### 3.2 create `views` folder

Here we will keep all of our HTML templates. We are using the `pub` library for it.

create 3 files:

- [layout.pub](/views/layout.pug) => this will define whole application layout
- [index.pub](/views/index.pug) => our main home page
- [error.pub](/views/error.pug) => error page to display any random errors.

#### 3.3 create `routes` folder

This folder will keep all the routes in one place.

create 2 files to define multiple routes:

- [HOME or index route](/routes/index.js)
- [User route](/routes/user.js)

we will be defining our HOME route to serve form with CSRF token.

- we are responding with the `index.pub` template with `title` and `token` as csrf token to the browser.

```
router.get("/", function (req, res, next) {
 if (req.session.csrf === undefined) {
 req.session.csrf = randomBytes(100).toString("base64");
 }

 res.render("index", { title: "Express", token: req.session.csrf });
});
```

- This route will take data submitted by the form mentioned above.
- This will also cross-check if the CSRF token is valid or not to check the validity of the request coming from any user.

```

router.post("/", function (req, res, next) {
 if (!req.body.csrf) {
 return res.send(`<p style="font-size: 4rem; color: red;">
<strong>CSRF Token not included.</strong>
</p>`);
 }

 if (req.body.csrf !== req.session.csrf) {
 return res.send(`<p style="font-size: 4rem; color: red;">
<strong>CSRF tokens do not match.</strong>
</p>`);
 }

 return res.send(`<p style="font-size: 4rem;">
<strong>Successful request!</strong>
</p>`);
});

```

#### 3.4 create `public` folder

keep all static assets here that you want to serve to the web.

eg:

- [styles.css](/public/styles.css)

---

#### 3.5 Add scripts in `package.json` file

```
"scripts": {
 "dev": "nodemon server.js",
 "start": "node server.js"
},
```

#### 3.6 running the application

```
# This will run code in development mode.
$ npm run dev
```

- now go to `localhost:3000`.
- the application will look something like the below image.
- also try to look at hidden input value where csrf value is present in `devtool`

![Home Page](/screenshots/home-page.png)

- now type anything in the input box and try to submit.
- you will see a success page like below after form submit

![Home Page](/screenshots/success-request.png)

- now try to submit a form from Postman.

![Home Page](/screenshots/postman-token-not-included.png)
![Home Page](/screenshots/postman-token-not-match.png)
![Home Page](/screenshots/postman-token-not-match-2.png)

## Conclusion

Implementing CSRF Token system depends on case to case basis, the current application is the demo of it, but it will become difficult to scale the current setup of the application where multiple servers will manage the separate token session. You should plan accordingly on how to scale applications or use a single form page separately in big applications.

## References

- https://crashtest-security.com/csrf-token-meaning/
- https://portswigger.net/web-security/csrf
- https://en.wikipedia.org/wiki/Cross-site_request_forgery
- https://owasp.org/www-community/attacks/csrf
- https://www.synopsys.com/glossary/what-is-csrf.html
- https://www.quora.com/What-are-the-differences-between-CSRF-and-CORS
- https://crashtest-security.com/csrf-token-meaning/
- https://www.shiftleft.io/community-and-training/vulnerability-fix-database/cross-site-request-forgery-node-security/
- https://gabrieleromanato.name/csrf-protection-in-expressjs
- https://levelup.gitconnected.com/how-to-implement-csrf-tokens-in-express-f867c9e95af0
